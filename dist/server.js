!function(e){var n={};function o(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=n,o.d=function(e,n,t){o.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,n){if(1&n&&(e=o(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(o.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var r in e)o.d(t,r,function(n){return e[n]}.bind(null,r));return t},o.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(n,"a",n),n},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.p="",o(o.s=12)}([function(e,n,o){"use strict";var t=o(4);const r=process.env.VCAP_SERVICES?JSON.parse(process.env.VCAP_SERVICES):null;n.a={version:t.version,commitVersion:t.commitVersion,env:"production",server:{port:process.env.PORT||4e3,VCAP_SERVICES:r,endpoints:{graphql:"/graphql",subscriptions:"/subscriptions",playground:!1}},database:{url:r?r.mongodbent[0].credentials.database_uri:"mongodb://127.0.0.1:27017/Webhook",init:process.argv[2]||!1},matchers:{phone:/^0041[0-9]{2}[0-9]{3}[0-9]{2}[0-9]{2}$/}}},function(e,n){e.exports=require("mongoose")},function(e,n,o){"use strict";o.r(n),o.d(n,"WebhookConntentSchema",function(){return s});var t=o(1),r=o.n(t);o(0);const i=r.a.Schema,s=new i({_id:{type:i.Types.ObjectId,required:!0,auto:!0},UserId:{type:String,required:!0},intTime:{type:Number,required:!0},WebhookConntent:{type:String,required:!0}});s.plugin(o(8));const a=r.a.model("WebhookConntent",s);n.default=a},function(e,n){e.exports={TestLink:e=>{let n=e.substring(0,3),o=e.substring(2,6),t=e.substring(6,70);return null!==e.match(/[\/]{1}[r]{1}[\/]{1}[u]{1}[s]{1}[\/]{1}[A-Za-z0-9]{64}/g)&&("/r/"===n&&("/us/"===o&&(70===e.length&&(!t.includes("/")&&(!t.includes("(")&&(!t.includes(")")&&(!t.includes('"')&&(!t.includes("}")&&(!t.includes("{")&&(!t.includes("?")&&(!t.includes("!")&&(!t.includes("&")&&(!t.includes("\\")&&(!t.includes("'")&&(!t.includes("'")&&t)))))))))))))))}}},function(e){e.exports={name:"Webhook-api",version:"0.1.31",description:"",main:"server.js",scripts:{start:"node ./dist/server.js",dev:"nodemon ./src/server.js --exec babel-node",initDb:"babel-node ./src/server.js init",initMockDb:"babel-node ./src/server.js initMock","build:dev":"webpack --config webpack.config.dev.js","build:prod":"webpack --config webpack.config.prod.js",tVersion:"node scripts/version.js","deploy:prod":"node scripts/deploy.js prod","deploy:dev":"node scripts/deploy.js dev"},author:"",license:"ISC",dependencies:{"contentful-webhook-listener":"^1.0.2","graphql-yoga":"^1.16.2",mongoose:"^5.2.15","mongoose-lifecycle":"^1.0.0","mongoose-unique-validator":"^2.0.1","node-webhooks":"^1.4.0",winston:"^3.1.0"},devDependencies:{"babel-cli":"^6.26.0","babel-core":"^6.26.3","babel-plugin-syntax-async-functions":"^6.13.0","babel-plugin-transform-regenerator":"^6.26.0","babel-polyfill":"^6.26.0","babel-preset-env":"^1.7.0","babel-preset-es2015":"^6.24.1","babel-register":"^6.26.0","copy-pkg-json-webpack-plugin":"0.0.38",nodemon:"^1.18.4",shelljs:"^0.8.2",webpack:"^4.19.0","webpack-cli":"^3.1.0","webpack-node-externals":"^1.7.2"},engines:{node:"8.11.4",npm:"6.2.0"}}},function(e,n){e.exports=require("graphql-yoga")},function(e,n){e.exports=require("mongoose-unique-validator")},function(e,n){e.exports=require("winston")},function(e,n){e.exports=require("mongoose-lifecycle")},function(e,n,o){"use strict";o.r(n),o.d(n,"UsersShema",function(){return l});var t=o(1),r=o.n(t),i=o(6),s=o.n(i);o(0);const a=r.a.Schema,l=new a({_id:{type:a.Types.ObjectId,required:!0,auto:!0},UserId:{type:String,required:!0},LoginToken:{type:String,required:!0},Email:{type:String},WebhookLinks:{type:[{_id:{type:a.Types.ObjectId,required:!0,auto:!0},LinkHash:{type:String,required:!0}}]}}).plugin(s.a),u=r.a.model("Users",l);n.default=u},function(e,n){e.exports=require("https")},function(e,n){e.exports=require("http")},function(e,n,o){"use strict";o.r(n);const t=o(7),r=t.createLogger({level:"info",format:t.format.simple(),transports:[]});r.add(new t.transports.Console({format:t.format.combine(t.format.colorize(),t.format.timestamp({format:"DD.MM.YYYY HH:mm:ss"}),t.format.align(),t.format.printf(e=>`${e.timestamp} [${e.level}]: ${e.message}`))})),r.logInfo=(e=>r.log({level:"info",message:e})),r.logError=(e=>r.log({level:"error",message:e}));var i=r,s=o(0),a=o(5),l=o(1),u=o.n(l);Array.prototype.shuffle=function(){var e,n,o;for(o=this.length-1;o>0;o--)e=Math.floor(Math.random()*(o+1)),n=this[o],this[o]=this[e],this[e]=n;return this};const c=async()=>{await d()},d=async()=>{let e=o(2).default,n=o(9).default;await e.deleteMany({}),await n.deleteMany({});await e.create([{UserId:"KLUGHILUSdgluiweiuzg",intTime:981237123,WebhookConntent:"Webhook Conntent test 1"},{UserId:"sadsda",intTime:981237123,WebhookConntent:"Webhook Cokajusgdasidugnntent test 2"},{UserId:"sdsdsdsdsd",intTime:981237123,WebhookConntent:"Webhook Conntent test 3"},{UserId:"KLUGHILUsdSdgluiweiuzg",intTime:981237123,WebhookConntent:"Webhook Conntent test 4"}]),await n.create([{UserId:"KLUGHILUsdSdgluiweiuzg",LoginToken:"Nisd02h81n89",Email:"test@email.com",WebhookLinks:[{LinkHash:"1111"},{LinkHash:"2222"},{LinkHash:"3333"}]},{UserId:"99999",LoginToken:"Nisd902h81n89",Email:"te9st@ema99il.co9m",WebhookLinks:[{LinkHash:"99"},{LinkHash:"99"},{LinkHash:"99"}]},{UserId:"123",LoginToken:"123",Email:"test@123.com",WebhookLinks:[{LinkHash:"000"},{LinkHash:"0"},{LinkHash:"00"}]}])};u.a.connect(s.a.database.url,{useNewUrlParser:!0}).then(()=>{if(i.logInfo("Successfully connected to database"),s.a.database.init){let e="init"===s.a.database.init?c:d,n="initMock"===s.a.database.init?" with mocked data":"";i.logInfo("Initializing DB"+n),e().then(e=>{i.logInfo("Done")}).catch(e=>{i.logError("Could not initialize DB"+n),i.logError(e)})}},e=>{i.logError("An error occured while connecting to the database"),i.logError(e),process.exit(1)});var p=o(2),g={Query:{WebhookByUser:async(e,{userid:n})=>await p.default.find({UserId:n.toString()}).sort({_id:-1}).limit(100)},Mutation:{NewWebhook:async(e,{uid:n,WConntent:o})=>await p.default.create({UserId:n,intTime:+new Date,WebhookConntent:o})},Subscription:{NewWebhookIncoming:{subscribe:(e,n,{pubsub:o})=>{const t=Math.random().toString(36).substring(2,15);return p.default.on("afterInsert",function(e){e.UserId===n.userid&&o.publish(t,{NewWebhookIncoming:e})}),o.asyncIterator(t)}}}};const b=new a.PubSub;var f=new a.GraphQLServer({typeDefs:"type WebhookConntent {\n  _id: String\n  UserId: String\n  intTime: Float\n  WebhookConntent: String\n}\n\ntype Users {\n  _id: String\n  UserId: String\n  LoginToken: String\n  Email: String\n}\n\ntype Mutation {\n  NewWebhook(uid: String, iTime: String, WConntent: String): WebhookConntent\n}\n\ntype Query {\n  WebhookByUser(userid: String): [WebhookConntent]\n}\n\ntype Subscription {\n  NewWebhookIncoming(userid: String): WebhookConntent\n}",resolvers:g,context:{pubsub:b}}),h={SaveWHtoDB:(e,n)=>{o(2).default.create([{UserId:""+n,intTime:Date.now(),WebhookConntent:""+e}])}},m=o(3),k=o.n(m);o(10);var y=o(11).createServer(function(e,n){var o="";"POST"==e.method?k.a.TestLink(e.url)?(e.on("data",function(e){o+=e}),e.on("end",function(){let n=k.a.TestLink(e.url),t=o.toString();h.SaveWHtoDB(t,n),console.log("Webhook Recived under: "+n),v=202})):v=400:"GET"==e.method&&(k.a.TestLink(e.url)?(v=400,console.log("GET = link is Fine")):(v=400,console.log("GET = link is NOT Fine!")));n.writeHead(v,{"Content-Type":"text/plain"}),n.end()}),v=403;y.listen(9e3),console.log("Listening to port 9000"),console.log("Returning status code "+v.toString()),i.logInfo(`ENVIRONMENT: ${s.a.env}`),i.logInfo(`VERSION: ${s.a.version}`),i.logInfo(`COMMIT VERSION: ${s.a.commitVersion}`),i.logInfo(`DATABASE URL: ${s.a.database.url}`),f.start({port:s.a.server.port,endpoint:s.a.server.endpoints.graphql,webhook:s.a.server.endpoints.webhook,subscriptions:s.a.server.endpoints.subscriptions,playground:s.a.server.endpoints.playground},()=>i.logInfo(`Server is running on localhost:${s.a.server.port}`)).catch(e=>{i.logError("An error occured while starting the graphql server"),i.logError(e),process.exit(1)})}]);